name: Release (reusable)

# Reusable workflow — called by consumer repos via:
#
#   uses: gbrennon/release_automation_golang/.github/workflows/release.yml@main

on:
  workflow_call:
    inputs:
      version:
        description: "Version tag to create (e.g. v1.2.3 or v1.2.3-rc1)"
        required: true
        type: string
      pre-release-hook:
        description: "Path to a pre-release hook script in the consumer repo (relative to repo root)"
        required: false
        type: string
        default: ""
    secrets:
      token:
        description: "GitHub token with contents:write permission"
        required: true

permissions:
  contents: write

jobs:
  tag-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout consumer repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run pre-release hook (if provided)
        if: inputs.pre-release-hook != ''
        run: |
          HOOK="${{ inputs.pre-release-hook }}"
          if [[ -f "$HOOK" ]]; then
            echo "→ Running pre-release hook: $HOOK"
            bash "$HOOK" "${{ inputs.version }}"
          else
            echo "Warning: pre-release hook '$HOOK' not found — skipping" >&2
          fi

      - name: Create and push tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ inputs.version }}"
          git push origin "${{ inputs.version }}"

      - name: Extract release notes from CHANGELOG.md
        id: release-notes
        run: |
          VERSION="${{ inputs.version }}"
          NOTES=$(awk -v ver="$VERSION" '
            /^## / { if (found) exit; if (index($0, ver)) found=1 }
            found  { print }
          ' CHANGELOG.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES"       >> $GITHUB_OUTPUT
          echo "EOF"          >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          body: ${{ steps.release-notes.outputs.content }}
          draft: false
          prerelease: ${{ contains(inputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.token }}
