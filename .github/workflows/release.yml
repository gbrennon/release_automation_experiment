name: Release (reusable)

on:
  workflow_call:
    inputs:
      version:
        description: "Version tag to create (e.g. v1.2.3 or v1.2.3-rc1)"
        required: true
        type: string
    secrets:
      token:
        description: "GitHub token with contents:write permission"
        required: true

permissions:
  contents: write

jobs:
  tag-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.token }}

      - name: Verify branch is main
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [[ "$BRANCH" != "main" ]]; then
            echo "✗ Expected main, got '$BRANCH' — tagging must happen on main" >&2
            exit 1
          fi
          echo "✓ On branch: $BRANCH" >&2

      - name: Create and push tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ inputs.version }}"
          git push origin "${{ inputs.version }}"
          echo "✓ Tag pushed: ${{ inputs.version }}" >&2

      - name: Extract release notes from CHANGELOG.md
        id: release-notes
        run: |
          VERSION="${{ inputs.version }}"
          NOTES=$(awk -v ver="$VERSION" '
            /^## / { if (found) exit; if (index($0, ver)) found=1 }
            found  { print }
          ' CHANGELOG.md)
          if [[ -z "$NOTES" ]]; then
            echo "Warning: no release notes found for $VERSION in CHANGELOG.md" >&2
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES"       >> $GITHUB_OUTPUT
          echo "EOF"          >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          body: ${{ steps.release-notes.outputs.content }}
          draft: false
          prerelease: ${{ contains(inputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.token }}
