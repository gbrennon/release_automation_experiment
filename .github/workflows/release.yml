name: Release (reusable)

# Reusable workflow — called by consumer repos via:
#
#   uses: gbrennon/release_automation_golang/.github/workflows/release.yml@main

on:
  workflow_call:
    inputs:
      version:
        description: "Version tag to create (e.g. v1.2.3 or v1.2.3-rc1)"
        required: true
        type: string
      automation-ref:
        description: "Git ref to pin the shared automation repo to (tag, branch, or SHA). Defaults to 'main' during development — pin to a tag once validated."
        required: false
        type: string
        default: "main"
      pre-release-hook:
        description: "Path to a pre-release hook script in the consumer repo (relative to repo root)"
        required: false
        type: string
        default: ""
    secrets:
      token:
        description: "GitHub token with contents:write permission"
        required: true

permissions:
  contents: write

jobs:
  tag-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout consumer repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout shared release-automation
        uses: actions/checkout@v4
        with:
          # github.action_repository resolves to the repo that hosts this workflow
          # (e.g. gbrennon/release_automation_golang), so no hardcoded name needed.
          repository: ${{ github.action_repository }}
          ref: ${{ inputs.automation-ref }}
          path: .release-automation

      - name: Run pre-release hook (if provided)
        if: inputs.pre-release-hook != ''
        run: |
          HOOK="${{ inputs.pre-release-hook }}"
          if [[ -f "$HOOK" ]]; then
            echo "→ Running pre-release hook: $HOOK"
            bash "$HOOK" "${{ inputs.version }}"
          else
            echo "Warning: pre-release hook '$HOOK' not found — skipping" >&2
          fi

      - name: Create and push tag
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ inputs.version }}"
          git push origin "${{ inputs.version }}"

      - name: Resolve cliff.toml
        id: cliff-config
        run: |
          # Prefer the consumer repo's own .cliff.toml if present,
          # otherwise fall back to the one bundled in this automation repo.
          if [[ -f ".cliff.toml" ]]; then
            echo "config=.cliff.toml" >> $GITHUB_OUTPUT
            echo "→ Using consumer .cliff.toml"
          else
            echo "config=.release-automation/.cliff.toml" >> $GITHUB_OUTPUT
            echo "→ Using shared .cliff.toml from ${{ github.action_repository }}"
          fi

      - name: Generate release notes with git-cliff
        id: changelog
        uses: orhun/git-cliff-action@main
        with:
          config: ${{ steps.cliff-config.outputs.config }}
          # --latest   : only emit the section for this version
          # --strip all: no header/footer, clean markdown for the release body
          args: --latest --strip all --verbose

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: ${{ contains(inputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.token }}
