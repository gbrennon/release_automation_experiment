#!/usr/bin/env bash
# scripts/release.sh
#
# Orchestrates a full release:
#   1. Computes the next version
#   2. Creates a release branch
#   3. Runs the pre-release hook (if present)
#   4. Commits and pushes the branch
#   5. Opens a Gitea/Codeberg PR via the API
#
# CHANGELOG.md is generated by CI (changelog.yml) when the PR is opened.
# git-cliff is NOT required locally.
#
# Callers are expected to have run preflight.sh beforehand.
#
# Usage:
#   ./scripts/release.sh <bump>
#
# Arguments:
#   bump   One of: patch | minor | major
#
# Environment:
#   RC              If set, passed through to next-version.sh for rc<N> suffix.
#   GITEA_TOKEN     Personal access token with repo scope (read from env or ~/.config/gitea/token).
#   GITEA_HOST      Gitea instance hostname. Defaults to codeberg.org.
#
# Hooks:
#   scripts/hooks/pre-release.sh   Run after branch creation, before the commit.
#                                  Receives <bump> and <tag> as arguments.
#                                  Any files it modifies will be included in the
#                                  release commit.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
PRE_RELEASE_HOOK="${SCRIPT_DIR}/hooks/pre-release.sh"

# --- Args ---

BUMP="${1:-}"

if [[ -z "$BUMP" ]]; then
  echo "Usage: $0 <patch|minor|major>" >&2
  exit 1
fi

# --- Resolve Gitea config ---

GITEA_HOST="${GITEA_HOST:-codeberg.org}"

# Token: prefer env var, fall back to the Gitea CLI config file
if [[ -z "${GITEA_TOKEN:-}" ]]; then
  TOKEN_FILE="${HOME}/.config/gitea/token"
  if [[ -f "$TOKEN_FILE" ]]; then
    GITEA_TOKEN=$(cat "$TOKEN_FILE")
  else
    echo "Error: GITEA_TOKEN is not set and ${TOKEN_FILE} does not exist." >&2
    echo "  Export GITEA_TOKEN or store your token in ${TOKEN_FILE}" >&2
    exit 1
  fi
fi

# Derive owner/repo from the git remote URL.
# Supports both SSH (git@codeberg.org:owner/repo.git) and HTTPS forms.
REMOTE_URL=$(git remote get-url origin)
REPO_SLUG=$(echo "$REMOTE_URL" \
  | sed -E 's|.*[:/]([^/]+/[^/]+)(\.git)?$|\1|')
REPO_OWNER="${REPO_SLUG%%/*}"
REPO_NAME="${REPO_SLUG##*/}"

echo "→ Gitea host : ${GITEA_HOST}"
echo "→ Repo       : ${REPO_OWNER}/${REPO_NAME}"

# --- Compute next version ---

NEXT_VERSION=$(RC="${RC:-}" "$SCRIPT_DIR/next-version.sh" "$BUMP")
TAG="v${NEXT_VERSION}"
BRANCH_NAME="release/${TAG}"

echo "→ bump       : $BUMP"
echo "→ version    : $TAG"
echo "→ branch     : $BRANCH_NAME"

# --- Create release branch ---

git checkout -b "$BRANCH_NAME"

# Restore original branch on failure
cleanup() {
  local exit_code=$?
  if [[ $exit_code -ne 0 ]]; then
    echo "✗ Release failed — cleaning up branch '$BRANCH_NAME'" >&2
    git checkout main
    git branch -D "$BRANCH_NAME" 2>/dev/null || true
  fi
}
trap cleanup EXIT

# --- Run pre-release hook (if present) ---

if [[ -x "$PRE_RELEASE_HOOK" ]]; then
  echo "→ Running pre-release hook..."
  "$PRE_RELEASE_HOOK" "$BUMP" "$TAG"
else
  echo "→ No pre-release hook found — skipping"
fi

# --- Commit and push ---

git add --all
git commit --allow-empty -m "chore(release): ${TAG}"
git push origin "$BRANCH_NAME"

# --- Ensure the 'release' label exists on Gitea ---
# The API returns 422 if it already exists — we ignore that.

curl -sSf -X POST \
  "https://${GITEA_HOST}/api/v1/repos/${REPO_OWNER}/${REPO_NAME}/labels" \
  -H "Authorization: token ${GITEA_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"name":"release","color":"#0075ca","description":"Release PR"}' \
  -o /dev/null \
  -w "" 2>/dev/null || true

# Resolve the label ID (needed to attach it to the PR)
LABEL_ID=$(curl -sSf \
  "https://${GITEA_HOST}/api/v1/repos/${REPO_OWNER}/${REPO_NAME}/labels" \
  -H "Authorization: token ${GITEA_TOKEN}" \
  | jq '.[] | select(.name=="release") | .id')

# --- Open Gitea PR ---
# Body is intentionally minimal — CI will update it with generated release notes.

echo "→ Opening PR..."

PR_RESPONSE=$(curl -sSf -X POST \
  "https://${GITEA_HOST}/api/v1/repos/${REPO_OWNER}/${REPO_NAME}/pulls" \
  -H "Authorization: token ${GITEA_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"title\": \"chore(release): ${TAG}\",
    \"body\": \"_Changelog will be generated and posted by CI shortly..._\",
    \"head\": \"${BRANCH_NAME}\",
    \"base\": \"main\",
    \"labels\": [${LABEL_ID}]
  }")

PR_NUMBER=$(echo "$PR_RESPONSE" | jq '.number')
PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')

echo "✓ PR #${PR_NUMBER} opened: ${PR_URL}"

# --- Return to main ---

git checkout main
git branch -D "$BRANCH_NAME"

echo "✓ Release PR opened for ${TAG} — CI will generate CHANGELOG.md"
