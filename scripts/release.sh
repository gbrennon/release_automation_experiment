#!/usr/bin/env bash
# scripts/release.sh
#
# Orchestrates a full release:
#   1. Computes the next version
#   2. Creates a release branch
#   3. Runs the pre-release hook (if present)
#   4. Commits and pushes the branch
#   5. Opens a GitHub PR
#
# CHANGELOG.md is generated by CI (changelog.yml) when the PR is opened.
# git-cliff is NOT required locally.
#
# Callers are expected to have run preflight.sh beforehand.
#
# Usage:
#   ./scripts/release.sh <bump>
#
# Arguments:
#   bump   One of: patch | minor | major
#
# Environment:
#   RC     If set, passed through to next-version.sh for rc<N> suffix.
#
# Hooks:
#   scripts/hooks/pre-release.sh   Run after branch creation, before the commit.
#                                  Receives <bump> and <tag> as arguments.
#                                  Any files it modifies will be included in the
#                                  release commit.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
PRE_RELEASE_HOOK="${SCRIPT_DIR}/hooks/pre-release.sh"

# --- Args ---

BUMP="${1:-}"

if [[ -z "$BUMP" ]]; then
  echo "Usage: $0 <patch|minor|major>" >&2
  exit 1
fi

# --- Compute next version ---

NEXT_VERSION=$(RC="${RC:-}" "$SCRIPT_DIR/next-version.sh" "$BUMP")
TAG="v${NEXT_VERSION}"
BRANCH_NAME="release/${TAG}"

echo "→ bump    : $BUMP"
echo "→ version : $TAG"
echo "→ branch  : $BRANCH_NAME"

# --- Create release branch ---

git checkout -b "$BRANCH_NAME"

# Restore original branch on failure
cleanup() {
  local exit_code=$?
  if [[ $exit_code -ne 0 ]]; then
    echo "✗ Release failed — cleaning up branch '$BRANCH_NAME'" >&2
    git checkout main
    git branch -D "$BRANCH_NAME" 2>/dev/null || true
  fi
}
trap cleanup EXIT

# --- Run pre-release hook (if present) ---
#
# The hook receives bump type and tag so it can make decisions
# (e.g. only rewrite go.mod on major bumps).
# Any files modified by the hook are staged and included in the release commit.

if [[ -x "$PRE_RELEASE_HOOK" ]]; then
  echo "→ Running pre-release hook..."
  "$PRE_RELEASE_HOOK" "$BUMP" "$TAG"
else
  echo "→ No pre-release hook found — skipping"
fi

# --- Commit and push ---
# CHANGELOG.md will be generated and committed by CI once the PR is opened.

git add --all
git commit --allow-empty -m "chore(release): ${TAG}"
git push origin "$BRANCH_NAME"

# --- Ensure the 'release' label exists ---
# gh pr create fails hard if the label is missing, so create it idempotently.

gh label create release \
  --description "Release PR" \
  --color 0075ca \
  2>/dev/null || true

# --- Open GitHub PR ---
# Body is intentionally minimal — CI will update it with the generated changelog.

echo "→ Opening PR..."
gh pr create \
  --title "chore(release): ${TAG}" \
  --body  "_Changelog will be generated and posted by CI shortly..._" \
  --base  main \
  --head  "$BRANCH_NAME" \
  --label release

# --- Return to main ---

git checkout main
git branch -D "$BRANCH_NAME"

echo "✓ Release PR opened for ${TAG} — CI will generate CHANGELOG.md"
